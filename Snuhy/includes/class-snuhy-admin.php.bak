<?php
if (!defined('ABSPATH')) { exit; }

class Snuhy_Admin {

    public function init(){
        add_action('admin_menu', [$this,'menus']);
        add_action('admin_enqueue_scripts', [$this,'enqueue_assets']);
    }

    public function menus(){
        add_menu_page(
            __('Snuhy','snuhy'),
            'Snuhy',
            'manage_options',
            'snuhy',
            [$this,'page_dashboard'],
            'dashicons-admin-links',
            58
        );

        add_submenu_page(
            'snuhy',
            __('Links','snuhy'),
            __('Links','snuhy'),
            'manage_options',
            'snuhy-links',
            [$this,'page_links']
        );

        add_submenu_page(
            'snuhy',
            __('Settings','snuhy'),
            __('Settings','snuhy'),
            'manage_options',
            'snuhy-settings',
            [$this,'page_settings']
        );
    }

    public function enqueue_assets($hook){
        // حمّل فقط داخل صفحات Snuhy
        $is_snuhy = isset($_GET['page']) && strpos(sanitize_text_field($_GET['page']), 'snuhy') === 0;
        if (!$is_snuhy) return;

        wp_enqueue_style('snuhy-admin', SNUHY_URL.'assets/admin.css', [], SNUHY_VER);
        wp_enqueue_script('snuhy-admin', SNUHY_URL.'assets/admin.js', ['jquery'], SNUHY_VER, true);

        wp_localize_script('snuhy-admin','SnuhyVars', [
            'nonce' => wp_create_nonce('wp_rest'),
            'rest'  => esc_url_raw( rest_url('/snuhy/v1') )
        ]);
    }

    public function page_dashboard(){
        echo '<div class="wrap"><h1>Snuhy</h1><p>'.esc_html__('Welcome to Snuhy dashboard. Use the Links tab to add rules.','snuhy').'</p></div>';
    }

    /**
     * صفحة الروابط — نموذج بسيط + جدول
     */
    public function page_links(){
        ?>
        <div class="wrap">
            <h1><?php esc_html_e('Links','snuhy'); ?></h1>

            <div id="snuhy-link-form" class="snuhy-card" style="max-width:900px;background:#fff;border:1px solid #e3e3e3;padding:16px;margin-top:16px;">
                <h2 class="title"><?php esc_html_e('Add / Edit Link','snuhy'); ?></h2>
                <table class="form-table" role="presentation">
                    <tbody>
                    <tr>
                        <th scope="row"><label for="snuhy-keyword"><?php esc_html_e('Keyword','snuhy'); ?></label></th>
                        <td><input type="text" id="snuhy-keyword" class="regular-text"></td>
                    </tr>
                    <tr>
                        <th scope="row"><label for="snuhy-url"><?php esc_html_e('Target URL','snuhy'); ?></label></th>
                        <td><input type="text" id="snuhy-url" class="regular-text" placeholder="https://example.com/page-or-/sample-page"></td>
                    </tr>
                    <tr>
                        <th scope="row"><label for="snuhy-rel"><?php esc_html_e('rel','snuhy'); ?></label></th>
                        <td><input type="text" id="snuhy-rel" class="regular-text" placeholder="nofollow, sponsored"></td>
                    </tr>
                    <tr>
                        <th scope="row"><label for="snuhy-type"><?php esc_html_e('Type','snuhy'); ?></label></th>
                        <td>
                            <select id="snuhy-type">
                                <option value="internal"><?php esc_html_e('Internal','snuhy'); ?></option>
                                <option value="external"><?php esc_html_e('External','snuhy'); ?></option>
                                <option value="aff"><?php esc_html_e('Affiliate','snuhy'); ?></option>
                            </select>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <p>
                    <button id="snuhy-save" class="button button-primary"><?php esc_html_e('Save','snuhy'); ?></button>
                    <button id="snuhy-reset" class="button"><?php esc_html_e('Reset','snuhy'); ?></button>
                </p>
            </div>

            <div class="snuhy-card" style="max-width:1200px;background:#fff;border:1px solid #e3e3e3;padding:16px;margin-top:16px;">
                <h2 class="title"><?php esc_html_e('Saved Links','snuhy'); ?></h2>
                <table class="widefat fixed striped">
                    <thead>
                        <tr>
                            <th><?php esc_html_e('ID','snuhy'); ?></th>
                            <th><?php esc_html_e('Keyword','snuhy'); ?></th>
                            <th><?php esc_html_e('Target URL','snuhy'); ?></th>
                            <th><?php esc_html_e('Type','snuhy'); ?></th>
                            <th><?php esc_html_e('rel','snuhy'); ?></th>
                            <th><?php esc_html_e('Enabled','snuhy'); ?></th>
                            <th><?php esc_html_e('Actions','snuhy'); ?></th>
                        </tr>
                    </thead>
                    <tbody id="snuhy-links-tbody">
                        <tr><td colspan="7"><?php esc_html_e('Loading...','snuhy'); ?></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <?php
    }

    public function page_settings(){
        echo '<div class="wrap"><h1>'.esc_html__('Settings','snuhy').'</h1>';
        // لو عندك تمبلت جاهز هنستخدمه، وإلا نعرض رسالة بسيطة
        $tpl = SNUHY_PATH.'templates/admin/settings.php';
        if (file_exists($tpl)) {
            include $tpl;
        } else {
            echo '<p>'.esc_html__('Settings template not found.','snuhy').'</p>';
        }
        echo '</div>';
    }
}
